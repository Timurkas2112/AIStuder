from together import Together
import PyPDF2
import tiktoken
from txt_to_blocks import count_tokens, split_by_tokens, extract_text_from_pdf
import json
import re
import os
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env
load_dotenv()

# # === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
# PDF_PATH = "/Users/timursaitbatalov/Downloads/978-5-7996-1198-9_2014.pdf"  # –ø—É—Ç—å –∫ –≤–∞—à–µ–º—É PDF
# TOKEN_LIMIT = 4000
# ENCODING_NAME = "cl100k_base"  # –¥–ª—è GPT-4 –∏ GPT-3.5-turbo

# # === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä–∞ ===
# encoding = tiktoken.get_encoding(ENCODING_NAME)

# full_text = extract_text_from_pdf(PDF_PATH)
# blocks = split_by_tokens(full_text, TOKEN_LIMIT)

# print(blocks[1])
api_key = os.getenv("TOGETHER_API_KEY")
client = Together(api_key=api_key)


def fix_invalid_escapes(s: str) -> str:
    """
    –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ escape-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ —Å–∏–º–≤–æ–ª—ã –≤ —Å—Ç—Ä–æ–∫–µ.
    
    Args:
        s: –ò—Å—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞, –≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—â–∞—è –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã
    
    Returns:
        –û—á–∏—â–µ–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞, –ø—Ä–∏–≥–æ–¥–Ω–∞—è –¥–ª—è JSON
    """
    # –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ escape-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ JSON
    valid_escapes = {'"', '\\', '/', 'b', 'f', 'n', 'r', 't', 'u'}
    
    # 1. –°–Ω–∞—á–∞–ª–∞ –∑–∞–º–µ–Ω—è–µ–º –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ escape-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    def replacer(match):
        escape_seq = match.group(0)  # –Ω–∞–ø—Ä–∏–º–µ—Ä \z
        next_char = escape_seq[1]
        if next_char not in valid_escapes:
            return next_char  # –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π —Å–ª—ç—à
        return escape_seq  # –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
    
    s = re.sub(r'\\.', replacer, s)
    
    # 2. –ó–∞—Ç–µ–º —É–¥–∞–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ —Å–∏–º–≤–æ–ª—ã (–∫—Ä–æ–º–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö)
    # –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —É–ø—Ä–∞–≤–ª—è—é—â–∏–µ —Å–∏–º–≤–æ–ª—ã: \t, \n, \r
    s = re.sub(r'[\x00-\x08\x0b\x0c\x0e-\x1f\x7f-\x9f]', '', s)
    
    return s
def get_small_chapter(structure):
    prompt = f"""
–Ø —Ç–µ–±–µ —Å–∫–∏–Ω—É —Å–ª–æ–≤–∞—Ä—å, —Ç–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –≥–ª–∞–≤—É, –ø–æ –∫–æ—Ç–æ—Ä–æ–π –±—É–¥—É—Ç —É—á–∏—Ç—å—Å—è —Å—Ç—É–¥–µ–Ω—Ç—ã.

–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã —Å—Ç—É–¥–µ–Ω—Ç –∏ –Ω–µ —Ö–æ—á–µ—à—å —á–∏—Ç–∞—Ç—å –¥–æ—Å–ª–æ–≤–Ω—ã–π –ø–µ—Ä–µ—Å–∫–∞–∑ –∫–Ω–∏–≥–∏, –∞ —Ö–æ—á–µ—à—å –ø–æ–Ω—è—Ç–Ω–æ–µ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ. –ò–º–µ–Ω–Ω–æ —Ç–∞–∫–∏–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `content` ‚Äî –Ω–µ –∫–æ–ø–∏—è —Ç–µ–∫—Å—Ç–∞, –∞ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É—á–µ–±–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª.

–ú–æ–∂–µ—Ç –±—ã—Ç—å —Ç–∞–∫–æ–µ, —á—Ç–æ –≥–ª–∞–≤ –¥–≤–µ, —Ç–æ–≥–¥–∞ —Ç–µ–±–µ –Ω–∞–¥–æ —Å–æ–µ–¥–∏–Ω–∏—Ç—å –≤ –æ–¥–Ω—É –≥–ª–∞–≤—É –∏ —Å–∫–æ—Ä–∞—Ç–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

üîπ –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:
[
  {{
    "chapter_id": "id –≥–ª–∞–≤—ã",
    "title": "–Ω–∞–∑–≤–∞–Ω–∏–µ –≥–ª–∞–≤—ã",
    "content": "–∑–¥–µ—Å—å –≥–ª–∞–≤–∞, –ø–æ –∫–æ—Ç–æ—Ä–æ–π –±—É–¥—É—Ç —É—á–∏—Ç—å—Å—è —Å—Ç—É–¥–µ–Ω—Ç—ã (title —Å—é–¥–∞ –ø–∏—Å–∞—Ç—å –Ω–µ –Ω–∞–¥–æ)",
    "status": "complete"
  }}
]
–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:

–í —Å–ª—É—á–∞–µ –µ—Å–ª–∏ –≥–ª–∞–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ –¥–≤–µ, —Ç–æ–≥–¥–∞ –≤ chapter_id –Ω–µ –Ω–∞–¥–æ —É–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ä–∞–∑—É –¥–≤–µ –≥–ª–∞–≤—ã, –∫–∞–∫ –ø—Ä–∏–º–µ—Ä 3-4, –Ω–∞–¥–æ —É–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—É—é, —Ç–æ –µ—Å—Ç—å 3.

–ú–∞—Ä–∫–∏—Ä—É–π content, —á—Ç–æ–±—ã –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º —è —Å–º–æ–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ markdown.

–û—Ç–≤–µ—Ç —Ç–æ–ª—å–∫–æ JSON ‚Äî –Ω–∏–∫–∞–∫–∏—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.

–í—Å–µ —Å—Ç—Ä–æ–∫–∏ ‚Äî –≤ –¥–≤–æ–π–Ω—ã—Ö –∫–∞–≤—ã—á–∫–∞—Ö ("), –≤ —Ç–æ–º —á–∏—Å–ª–µ –∫–ª—é—á–∏ –∏ –∑–Ω–∞—á–µ–Ω–∏—è JSON.

–ú–∞–∫—Å–∏–º—É–º 900 —Å–ª–æ–≤ –Ω–∞ –≤–µ—Å—å –æ—Ç–≤–µ—Ç.

–í–æ—Ç —Å–ª–æ–≤–∞—Ä—å:
{structure}
"""
    response = client.chat.completions.create(
        model="meta-llama/Llama-3.3-70B-Instruct-Turbo-Free",
        messages=[{"role": "user", "content": prompt}]
    )
    return response.choices[0].message.content


def get_chapter(block, structure):
    prompt = f"""
–Ø —Ç–µ–±–µ —Å–∫–∏–Ω—É –º–∞—Ç–µ—Ä–∏–∞–ª, —Ç–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞—Ç—å –≥–ª–∞–≤—É, –ø–æ –∫–æ—Ç–æ—Ä–æ–π –±—É–¥—É—Ç —É—á–∏—Ç—å—Å—è —Å—Ç—É–¥–µ–Ω—Ç—ã.

–Ø —Ç–µ–±–µ –ø–µ—Ä–µ–¥–∞—é –±–ª–æ–∫–∏ –∫–Ω–∏–≥–∏. –ú–æ–∂–µ—Ç –±—ã—Ç—å —Ç–∞–∫–æ–µ, —á—Ç–æ –≤ –∫–æ–Ω—Ü–µ —Ç–µ–∫—Å—Ç —Ä–µ–∑–∫–æ –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è ‚Äî –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –ª–æ–≥–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ–∫—É—â—É—é –≥–ª–∞–≤—É, –æ–ø–∏—Å–∞–≤ —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –µ—Å—Ç—å, –∏ –Ω–∞—á–∞—Ç—å —Å–ª–µ–¥—É—é—â—É—é –≥–ª–∞–≤—É, —É–∫–∞–∑–∞–≤ –≤ –µ—ë —Å—Ç–∞—Ç—É—Å–µ `"incomplete"`. –í —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ —è –ø–µ—Ä–µ–¥–∞–º –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ.

–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ —Ç—ã —Å—Ç—É–¥–µ–Ω—Ç –∏ –Ω–µ —Ö–æ—á–µ—à—å —á–∏—Ç–∞—Ç—å –¥–æ—Å–ª–æ–≤–Ω—ã–π –ø–µ—Ä–µ—Å–∫–∞–∑ –∫–Ω–∏–≥–∏, –∞ —Ö–æ—á–µ—à—å –ø–æ–Ω—è—Ç–Ω–æ–µ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ. –ò–º–µ–Ω–Ω–æ —Ç–∞–∫–∏–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `content` ‚Äî –Ω–µ –∫–æ–ø–∏—è —Ç–µ–∫—Å—Ç–∞, –∞ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É—á–µ–±–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª.

üîπ –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:
[
  {{
    "chapter_id": "id –≥–ª–∞–≤—ã",
    "title": "–Ω–∞–∑–≤–∞–Ω–∏–µ –≥–ª–∞–≤—ã",
    "content": "–∑–¥–µ—Å—å –≥–ª–∞–≤–∞, –ø–æ –∫–æ—Ç–æ—Ä–æ–π –±—É–¥—É—Ç —É—á–∏—Ç—å—Å—è —Å—Ç—É–¥–µ–Ω—Ç—ã (title —Å—é–¥–∞ –ø–∏—Å–∞—Ç—å –Ω–µ –Ω–∞–¥–æ)",
    "status": "complete" –∏–ª–∏ "incomplete"
  }},
  ...
]
–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:

–ú–∞—Ä–∫–∏—Ä—É–π content, —á—Ç–æ–±—ã –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º —è —Å–º–æ–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ markdown.

–û—Ç–≤–µ—Ç —Ç–æ–ª—å–∫–æ JSON ‚Äî –Ω–∏–∫–∞–∫–∏—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –ª–∏—à–Ω–µ–≥–æ —Ç–µ–∫—Å—Ç–∞.

–í—Å–µ —Å—Ç—Ä–æ–∫–∏ ‚Äî –≤ –¥–≤–æ–π–Ω—ã—Ö –∫–∞–≤—ã—á–∫–∞—Ö ("), –≤ —Ç–æ–º —á–∏—Å–ª–µ –∫–ª—é—á–∏ –∏ –∑–Ω–∞—á–µ–Ω–∏—è JSON.

–ú–∞–∫—Å–∏–º—É–º 900 —Å–ª–æ–≤ –Ω–∞ –≤–µ—Å—å –æ—Ç–≤–µ—Ç.

–õ—É—á—à–µ —Å–¥–µ–ª–∞—Ç—å –º–∞–ª–æ, –Ω–æ –æ–±—ä—ë–º–Ω—ã—Ö –≥–ª–∞–≤.

–ó–∞ –æ–¥–∏–Ω —Ä–∞–∑ –º–æ–∂–µ—à—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 1 –∏–ª–∏ 2 –≥–ª–∞–≤—ã:

–ï—Å–ª–∏ 1 –≥–ª–∞–≤–∞ ‚Äî –¥–æ 800 —Å–ª–æ–≤.

–ï—Å–ª–∏ 2 –≥–ª–∞–≤—ã ‚Äî –¥–æ 400 —Å–ª–æ–≤ –Ω–∞ –∫–∞–∂–¥—É—é.

{structure}
–í–æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª:
{block}"""
    
    response = client.chat.completions.create(
        model="meta-llama/Llama-3.3-70B-Instruct-Turbo-Free",
        messages=[{"role": "user", "content": prompt}]
    )
    return response.choices[0].message.content

def generate_quiz_for_chapter(chapter):
    prompt = '''–¢–≤–æ—è –∑–∞–¥–∞—á–∞ –∑–∞–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ñ–æ—Ä–º–∞—Ç–µ:
{"questions": [{"question": "–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞","options": ["–≤–∞—Ä–∏–∞–Ω—Ç1", "–≤–∞—Ä–∏–∞–Ω—Ç2", "–≤–∞—Ä–∏–∞–Ω—Ç3", "–≤–∞—Ä–∏–∞–Ω—Ç4"],"correct_answer": "–Ω–æ–º–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 1)","type": "single","explanation": "–û–±—ä—è—Å–Ω–µ–Ω–∏–µ"},...]}"""
–í—ã–≤–µ–¥–∏ –≤—Å–µ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ—á–∫—É.
–í–æ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É —Ç—ã –¥–æ–ª–∂–µ–Ω –≤—Å–µ –∑–∞–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å: ''' + chapter
    response = client.chat.completions.create(
        model="meta-llama/Llama-3.3-70B-Instruct-Turbo-Free",
        messages=[{"role": "user", "content": prompt}]
    )
    return response.choices[0].message.content